<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="lectureMapper">
  	<resultMap id="lectureResult" type="Lecture">
  		<result column="class_no" property="classNo"/>
  		<result column="class_title" property="classTitle"/>
  		<result column="create_date" property="createDate"/>
  		<result column="thumbnail" property="thumbnail"/>
  		<result column="intro_file" property="introFile"/>
  		<result column="intro_title" property="introTitle"/>
  		<result column="intro_content" property="introContent"/>
  		<result column="status" property="status"/>
  		<result column="period" property="period"/>
  		<result column="need" property="need"/>
  		<result column="note" property="note"/>
  		<result column="pos_term" property="posTerm"/>
  		<result column="price" property="price"/>
  		<result column="subcat_no" property="subcatNo"/>
  		<result column="user_no" property="userNo"/>
		<result column="count" property="fundingCount"/>
		<result column="nickname" property="teacherName"/>
		<result column="scrap" property="scrapCount"/>
		<result column="students" property="students"/>  	
		<result column="star" property="star"/>
	</resultMap>
  	
  	<resultMap id="studingResult" type="Studing">
		<result column="user_no" property="userNo"/>
		<result column="class_no" property="classNo"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<result column="video_no" property="videoNo"/>
	</resultMap>
	
	<resultMap type="ScrapSupport" id="scrapResult">
		<result column="user_no" property="userNo"/>
		<result column="class_no" property="classNo"/>
		<result column="type" property="type"/>
		<result column="scrap_date" property="scrapDate"/>
	</resultMap>
	
	<resultMap id="classVideoResult" type="ClassVideo">
		<result column="video_no" property="videoNo"/>
		<result column="class_no" property="classNo"/>
		<result column="chap_order" property="chapOrder"/>
		<result column="video_order" property="videoOrder"/>
		<result column="sub_title" property="subTitle"/>
		<result column="origin_name" property="originName"/>
		<result column="change_name" property="changeName"/>
	</resultMap>
	
	<resultMap id="chapterResult" type="Chapter">
		<result column="chap_order" property="chapOrder"/>
		<result column="class_no" property="classNo"/>
		<result column="chap_name" property="chapName"/>
	</resultMap>
  	
  	<!-- 
  		@author HeeRak
  		월별정산_ 한 강사의 모든 클래스번호, 이름 조회 
  	-->
  	<select id="selectTeacherClassAll" resultMap="lectureResult">
  		select
  			   class_no
  			 , class_title
  		  from lecture
  		 where user_no = #{userNo}
  		   and status = 'O'
  		 order
  		    by create_date asc
  	</select>
  	
  	<!-- 
		@author leeyeji
		펀딩 클래스 페이징	
	 -->
	 <select id="selectFundingCount" resultType="_int">
	 	select
	 		   count(*)
	 	  from class_funding 
	 </select>
	
	<!-- 
		@author leeyeji
		펀딩 클래스 조회용
	 -->
	<select id="selectFundingList" resultMap="lectureResult">
		select 
               class_no
             , thumbnail
             , class_title
             , create_date
             , f.count
             , t.nickname
          from lecture l
          join class_funding f using(class_no)
          join teacher t on(l.user_no = t.teacher_no)
         where l.status = 'F'
         order 
            by create_date desc
	</select>
	
	<!-- 
		@author : yeji Lee
		페이징 처리
	 -->
	<select id="selectListCount" resultType="_int">
		select
		 	   count(*)
		  from lecture
		 where status = 'O' 
	</select>
	
	<!-- 
		@author : yeji Lee
		클래스 리스트 조회
	 -->
	<select id="selectLectureList" resultMap="lectureResult">
		select
		       l.class_no
		     , l.class_title
		     , l.create_date
		     , l.thumbnail
		     , l.price
		     , (select 
		               round(avg(score))
		          from survey
		         where class_no = l.class_no) star
		     , (select
		               count(*)
		          from scrap_support
		         where type = 'S'
		           and class_no = l.class_no) scrap
		     , (select
		               count(*)
		          from payment
		         where class_no = l.class_no) students
		     , t.nickname
		  from lecture l
		  left outer join (
		                    select 
		                           teacher_no, nickname
		                      from teacher
		                  ) t 
		                  on l.user_no = t.teacher_no
		 where l.status = 'O'
		 order 
		 <choose>
		 	<when test="sno == 3">
		    	by students desc
		    </when>
		    <when test="sno == 2">
		    	by star desc
		    </when>
		    <otherwise>
		    	by scrap desc
		    </otherwise>
		 </choose>
	</select>
	
  	<!--
		한 강사의 '클래스 목록 수' 
		@author HeeRak
	-->
	<select id="selectLectureListCount" resultType="_int">
		select count(*)
		  from lecture
		 where status != 'D'
		   and user_no = #{userNo}
	</select>
	
	<!--
		한 강사의 '클래스 목록'
		@author HeeRak
	-->
	<select id="selectLectureByTeacher" resultMap="lectureResult">
		select 
			   class_no
			 , class_title
			 , to_char(create_date, 'YYYY-MM-DD') as create_date
			 , thumbnail
			 , status
			 , subcat_no
		  from lecture
		 where status != 'D'
		   and user_no = #{userNo}
		 order
		    by create_date desc
	</select>
	
	<!-- 
		한 클래스 '클래스 챕터 목록'
		@author HeeRak
	 -->
	<select id="selectChapterList" resultMap="chapterResult">
		select chap_order
			 , class_no
		     , chap_name
		  from chapter
		 where class_no = #{classNo}
		 order
		    by chap_order asc
	</select>
  	
  	
  	<!-- 
		한 클래스 '클래스 비디오 목록'
		@author HeeRak
	 -->
  	<select id="ajaxSelectVideoList" resultMap="classVideoResult">
		select 
		       video_no
		     , chap_order
		     , sub_title
		     , change_name
		  from class_video
		 where class_no = #{classNo}
		 order
    	    by video_no asc
	</select>
	
	<!-- 
		
	 -->
	<update id="ajaxUpdateClassStuding" parameterType="ClassStuding">
		update class_studing
		   set video_no = #{videoNo}
		 where user_no = #{userNo}
		   and class_no =  #{classNo}
	</update>
</mapper>
